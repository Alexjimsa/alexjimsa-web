---
import { getCollection } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';

const { pathname } = Astro.url;
const current = pathname.startsWith('/en/') ? 'en' : 'es';
const other = current === 'en' ? 'es' : 'en';

// Stripped pathname without locale prefix
const bare = pathname.replace(/^\/en\//, '/').replace(/\/$/, '');
const section = bare.split('/')[1];

let enHref = getRelativeLocaleUrl('en', bare);
let esHref = getRelativeLocaleUrl('es', bare);

if (section === 'projects' && /^\/projects\/[^/]+\/?$/.test(bare)) {
  const slug = bare.split('/').pop();
  const entries = await getCollection('projects');
  
  // Buscar la entrada actual por slug y lenguaje
  const currentEntry = entries.find(e => {
    const entrySlug = e.data.slug?.replace(/-[a-z]{2}$/, ''); // Elimina el sufijo de idioma
    const compareSlug = slug?.replace(/-[a-z]{2}$/, '');
    return e.data.lang === current && entrySlug === compareSlug;
  });

  if (currentEntry) {
    // Buscar la entrada correspondiente en el otro idioma usando translationKey
    const sibling = entries.find(e => 
      e.data.translationKey === currentEntry.data.translationKey && 
      e.data.lang === other && 
      (e.data.published ?? true)
    );

    if (sibling) {
      if (current === 'es') {
        enHref = getRelativeLocaleUrl('en', `projects/${sibling.data.slug}`);
      } else {
        esHref = getRelativeLocaleUrl('es', `projects/${sibling.data.slug}`);
      }
    }
  }
}

// Hacer lo mismo para la secciÃ³n de blog
if (section === 'blog' && /^\/blog\/[^/]+\/?$/.test(bare)) {
  const slug = bare.split('/').pop();
  const entries = await getCollection('blog');
  
  const currentEntry = entries.find(e => {
    const entrySlug = e.data.slug?.replace(/-[a-z]{2}$/, '');
    const compareSlug = slug?.replace(/-[a-z]{2}$/, '');
    return e.data.lang === current && entrySlug === compareSlug;
  });

  if (currentEntry) {
    const sibling = entries.find(e => 
      e.data.translationKey === currentEntry.data.translationKey && 
      e.data.lang === other && 
      (e.data.published ?? true)
    );

    if (sibling) {
      if (current === 'es') {
        enHref = getRelativeLocaleUrl('en', `blog/${sibling.data.slug}`);
      } else {
        esHref = getRelativeLocaleUrl('es', `blog/${sibling.data.slug}`);
      }
    }
  }
}
---


<nav aria-label="Language Switcher">
  <a href={esHref} hreflang="es" rel="alternate" aria-current={current === 'es' ? 'page' : undefined}>ES</a>
  <span aria-hidden="true">|</span>
  <a href={enHref} hreflang="en" rel="alternate" aria-current={current === 'en' ? 'page' : undefined}>EN</a>
</nav>

<style>
  nav { display:inline-flex; align-items:center; gap:.5rem; }
  nav a { text-decoration:none; color: var(--color-text_muted); }
  nav a[aria-current="page"] { font-weight:700; color:var(--color-text); text-decoration: underline; text-underline-offset:.2em; }
  nav a:hover, nav a:focus { color: var(--color-text); }
</style>
